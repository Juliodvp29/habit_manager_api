<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Deployment

When you're ready to deploy your NestJS application to production, there are some key steps you can take to ensure it runs as efficiently as possible. Check out the [deployment documentation](https://docs.nestjs.com/deployment) for more information.

If you are looking for a cloud-based platform to deploy your NestJS application, check out [Mau](https://mau.nestjs.com), our official platform for deploying NestJS applications on AWS. Mau makes deployment straightforward and fast, requiring just a few simple steps:

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

With Mau, you can deploy your application in just a few clicks, allowing you to focus on building features rather than managing infrastructure.

## Resources

Check out a few resources that may come in handy when working with NestJS:

- Visit the [NestJS Documentation](https://docs.nestjs.com) to learn more about the framework.
- For questions and support, please visit our [Discord channel](https://discord.gg/G7Qnnhy).
- To dive deeper and get more hands-on experience, check out our official video [courses](https://courses.nestjs.com/).
- Deploy your application to AWS with the help of [NestJS Mau](https://mau.nestjs.com) in just a few clicks.
- Visualize your application graph and interact with the NestJS application in real-time using [NestJS Devtools](https://devtools.nestjs.com).
- Need help with your project (part-time to full-time)? Check out our official [enterprise support](https://enterprise.nestjs.com).
- To stay in the loop and get updates, follow us on [X](https://x.com/nestframework) and [LinkedIn](https://linkedin.com/company/nestjs).
- Looking for a job, or have a job to offer? Check out our official [Jobs board](https://jobs.nestjs.com).

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil My≈õliwiec](https://twitter.com/kammysliwiec)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).


# üìö Habit Manager API - Documentaci√≥n

**Versi√≥n:** 0.0.1
**Framework:** NestJS v11 + TypeScript
**Base de Datos:** PostgreSQL
**Arquitectura:** REST API con autenticaci√≥n JWT

---

## üìã Tabla de Contenidos

1. [Descripci√≥n General](#descripci√≥n-general)
2. [Caracter√≠sticas Implementadas](#caracter√≠sticas-implementadas)
3. [Instalaci√≥n y Configuraci√≥n](#instalaci√≥n-y-configuraci√≥n)
4. [Variables de Entorno](#variables-de-entorno)
5. [Endpoints de la API](#endpoints-de-la-api)
6. [Autenticaci√≥n y Seguridad](#autenticaci√≥n-y-seguridad)
7. [Funcionalidades Pendientes](#funcionalidades-pendientes)
8. [Estructura del Proyecto](#estructura-del-proyecto)

---

## üéØ Descripci√≥n General

API REST desarrollada en NestJS para el proyecto **Habit Manager con IA**. Esta API proporciona servicios de backend para una aplicaci√≥n m√≥vil h√≠brida que permite a los usuarios crear, gestionar y analizar sus h√°bitos con ayuda de inteligencia artificial.

### Tecnolog√≠as Principales
- **NestJS** v11 - Framework de Node.js
- **TypeORM** v0.3.27 - ORM para PostgreSQL
- **PostgreSQL** - Base de datos relacional
- **JWT** - Autenticaci√≥n basada en tokens
- **bcrypt** v6.0.0 - Hash de contrase√±as
- **Nodemailer** v7.0.9 - Env√≠o de correos electr√≥nicos
- **OpenAI API** - An√°lisis y recomendaciones con IA (opcional)
- **Passport** - Autenticaci√≥n con estrategias
- **Helmet** - Seguridad HTTP headers
- **Morgan** - Logging HTTP
- **CORS** - Configuraci√≥n de CORS

---

## ‚úÖ Caracter√≠sticas Implementadas

### üîê Autenticaci√≥n y Seguridad (RF-01)
- ‚úÖ Registro de usuarios con hash de contrase√±as (bcrypt)
- ‚úÖ Login con JWT
- ‚úÖ Verificaci√≥n de email mediante c√≥digo de 6 d√≠gitos
- ‚úÖ Autenticaci√≥n de dos factores (2FA) obligatoria
- ‚úÖ Recuperaci√≥n de contrase√±a
- ‚úÖ Reenv√≠o de c√≥digos de verificaci√≥n
- ‚úÖ Registro de intentos de login (IP y User-Agent)
- ‚úÖ Protecci√≥n de rutas con Guards JWT
- ‚úÖ **Soluci√≥n implementada para restricci√≥n unique_active_code** - Evita conflictos en verificaci√≥n de c√≥digos
- ‚úÖ **Logging detallado** para debugging de procesos de verificaci√≥n

### üìù Gesti√≥n de H√°bitos (RF-02, RF-03)
- ‚úÖ CRUD completo de h√°bitos
- ‚úÖ Registro de progreso diario (logs)
- ‚úÖ Dashboard con resumen de h√°bitos
- ‚úÖ Estad√≠sticas detalladas por h√°bito
- ‚úÖ Soporte para frecuencias (daily, weekly, monthly)
- ‚úÖ Activaci√≥n/desactivaci√≥n de h√°bitos

### üß† Inteligencia Artificial (RF-04, RF-07)
- ‚úÖ An√°lisis profundo de patrones de cumplimiento
- ‚úÖ Detecci√≥n de mejores y peores d√≠as
- ‚úÖ C√°lculo de rachas (actual y m√°s larga)
- ‚úÖ Identificaci√≥n de tendencias (mejorando/decayendo/estable)
- ‚úÖ Recomendaciones personalizadas con OpenAI GPT-4
- ‚úÖ Mensajes motivacionales adaptativos
- ‚úÖ Sugerencias autom√°ticas inteligentes
- ‚úÖ Historial de recomendaciones

### üîî Notificaciones (RF-05)
- ‚úÖ Sistema completo de notificaciones inteligentes
- ‚úÖ Creaci√≥n autom√°tica de notificaciones programadas
- ‚úÖ Recordatorios diarios personalizados (configurable por hora)
- ‚úÖ Mensajes motivacionales diarios aleatorios
- ‚úÖ Notificaciones de rachas y logros (3, 7, 30 d√≠as)
- ‚úÖ Alertas de seguridad por intentos fallidos de login
- ‚úÖ Res√∫menes semanales de progreso
- ‚úÖ Notificaciones de login desde nueva ubicaci√≥n
- ‚úÖ Marcado de notificaciones como le√≠das
- ‚úÖ Limpieza autom√°tica de notificaciones antiguas
- ‚úÖ Respeta configuraciones de usuario (notificationEnabled)
- ‚ö†Ô∏è **Pendiente:** Integraci√≥n con Firebase Cloud Messaging (FCM) para push notifications

### üîÑ Sincronizaci√≥n Offline (RF-09)
- ‚úÖ Sincronizaci√≥n bidireccional de h√°bitos y logs
- ‚úÖ Detecci√≥n y resoluci√≥n de conflictos
- ‚úÖ Obtenci√≥n de cambios desde √∫ltima sincronizaci√≥n
- ‚úÖ Timestamps de sincronizaci√≥n

### üë§ Gesti√≥n de Usuarios
- ‚úÖ Perfil de usuario con foto
- ‚úÖ Configuraci√≥n de preferencias
- ‚úÖ Soporte multilenguaje (es/en)
- ‚úÖ Temas (claro/oscuro)
- ‚úÖ Eliminaci√≥n de cuenta

---

## üöÄ Instalaci√≥n y Configuraci√≥n

### Requisitos Previos
- Node.js >= 18.x
- PostgreSQL >= 14.x
- npm >= 8.x

### Pasos de Instalaci√≥n

```bash
# 1. Clonar el repositorio
git clone https://github.com/Juliodvp29/habit_manager_api.git
cd habit_manager_api

# 2. Instalar dependencias
npm install

# 3. Configurar variables de entorno
cp .env.example .env
# Editar .env con tus credenciales

# 4. Configurar base de datos
# Ejecutar el script SQL habit_ai_v2.sql en PostgreSQL para crear las tablas

# 5. Iniciar el servidor en desarrollo
npm run start:dev

# 6. Iniciar el servidor en producci√≥n
npm run build
npm run start:prod
```

---

## üîß Variables de Entorno

Crear archivo `.env` en la ra√≠z del proyecto:

```env
# Base de datos
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=tu_password
DB_DATABASE=habit_manager

# JWT
JWT_SECRET=tu_clave_secreta_super_segura
JWT_EXPIRATION=7d

# OpenAI (Opcional - si no se configura, usa mensajes predeterminados)
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx

# Servidor de correo (SMTP)
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USER=tu_email@gmail.com
MAIL_PASSWORD=tu_app_password
MAIL_FROM="Habit Manager <noreply@habitmanager.com>"

# Configuraci√≥n general
NODE_ENV=development
PORT=3000
CORS_ORIGIN=http://localhost:8100

# Seguridad
MAX_VERIFICATION_ATTEMPTS=3


# Firebase Cloud Messaging
FIREBASE_PROJECT_ID=tu-proyecto-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@tu-proyecto.iam.gserviceaccount.com
# O simplemente la ruta al archivo JSON
FIREBASE_CREDENTIALS_PATH=./config/firebase-admin-sdk.json

```

---

## üåê Endpoints de la API

**Base URL:** `http://localhost:3000/api/v1`

### üîê Autenticaci√≥n (`/auth`)

#### Registro de Usuario
```http
POST /auth/register
```

**Body:**
```json
{
  "email": "usuario@ejemplo.com",
  "password": "contrase√±a123",
  "fullName": "Juan P√©rez"
}
```

**Respuesta (201):**
```json
{
  "message": "Usuario registrado. Por favor verifica tu email.",
  "user": {
    "id": 1,
    "email": "usuario@ejemplo.com",
    "fullName": "Juan P√©rez",
    "isEmailVerified": false
  },
  "emailSent": true,
  "requiresVerification": true
}
```

---

#### Login
```http
POST /auth/login
```

**Body:**
```json
{
  "email": "usuario@ejemplo.com",
  "password": "contrase√±a123"
}
```

**Respuesta (200) - Si requiere 2FA:**
```json
{
  "requires2FA": true,
  "message": "Se ha enviado un c√≥digo de verificaci√≥n a tu email",
  "userId": 1,
  "email": "u******o@ejemplo.com"
}
```

---

#### Verificar 2FA
```http
POST /auth/verify-2fa
```

**Body:**
```json
{
  "userId": 1,
  "code": "123456"
}
```

**Respuesta (200):**
```json
{
  "user": {
    "id": 1,
    "email": "usuario@ejemplo.com",
    "fullName": "Juan P√©rez"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "message": "Login exitoso"
}
```

---

#### Logout
```http
POST /auth/logout
Authorization: Bearer {token}
```

**Body:**
```json
{
  "refreshToken": "string"
}
```

**Respuesta (200):**
```json
{
  "message": "Logout exitoso"
}
```

---

#### Refresh Token
```http
POST /auth/refresh
```

**Body:**
```json
{
  "refreshToken": "string",
  "userId": 1
}
```

**Respuesta (200):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "message": "Token renovado exitosamente"
}
```

---

#### Obtener Perfil
```http
GET /auth/profile
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "id": 1,
  "email": "usuario@ejemplo.com",
  "fullName": "Juan P√©rez",
  "profilePicture": null,
  "isEmailVerified": true,
  "preferredLanguage": {
    "id": 1,
    "code": "es",
    "name": "Espa√±ol"
  }
}
```

---

### ‚úâÔ∏è Verificaci√≥n (`/verification`)

#### Verificar Email
```http
POST /verification/verify-email
```

**Body:**
```json
{
  "email": "usuario@ejemplo.com",
  "code": "123456"
}
```

**Respuesta (200):**
```json
{
  "message": "Email verificado exitosamente",
  "verified": true
}
```

---

#### Reenviar C√≥digo de Verificaci√≥n
```http
POST /verification/resend-code
```

**Body:**
```json
{
  "email": "usuario@ejemplo.com"
}
```

---

#### Enviar C√≥digo de Verificaci√≥n de Email
```http
POST /verification/send-email-code
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "message": "C√≥digo de verificaci√≥n enviado a tu email",
  "emailSent": true
}
```

---

#### Enviar C√≥digo 2FA
```http
POST /verification/send-2fa-code
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "message": "C√≥digo 2FA enviado a tu email",
  "emailSent": true
}
```

---

#### Solicitar Recuperaci√≥n de Contrase√±a
```http
POST /verification/request-password-reset
```

**Body:**
```json
{
  "email": "usuario@ejemplo.com"
}
```

---

#### Restablecer Contrase√±a
```http
POST /verification/reset-password
```

**Body:**
```json
{
  "email": "usuario@ejemplo.com",
  "code": "123456",
  "newPassword": "nuevaContrase√±a123"
}
```

---

### üìù H√°bitos (`/habits`)

**‚ö†Ô∏è Requiere autenticaci√≥n JWT en todas las rutas**

#### Crear H√°bito
```http
POST /habits
Authorization: Bearer {token}
```

**Body:**
```json
{
  "title": "Meditar",
  "description": "Meditar 10 minutos al d√≠a",
  "frequency": "daily",
  "targetCount": 1
}
```

**Respuesta (201):**
```json
{
  "id": 1,
  "title": "Meditar",
  "description": "Meditar 10 minutos al d√≠a",
  "frequency": "daily",
  "targetCount": 1,
  "isActive": true,
  "createdAt": "2025-01-15T10:00:00Z"
}
```

---

#### Obtener Todos los H√°bitos
```http
GET /habits
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
[
  {
    "id": 1,
    "title": "Meditar",
    "description": "Meditar 10 minutos al d√≠a",
    "frequency": "daily",
    "targetCount": 1,
    "isActive": true,
    "createdAt": "2025-01-15T10:00:00Z"
  }
]
```

---

#### Obtener Dashboard
```http
GET /habits/dashboard
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
[
  {
    "id": 1,
    "title": "Meditar",
    "description": "Meditar 10 minutos al d√≠a",
    "frequency": "daily",
    "targetCount": 1,
    "todayCompleted": true,
    "todayProgress": 1
  }
]
```

---

#### Obtener H√°bito por ID
```http
GET /habits/:id
Authorization: Bearer {token}
```

---

#### Actualizar H√°bito
```http
PATCH /habits/:id
Authorization: Bearer {token}
```

**Body:**
```json
{
  "title": "Meditar y respirar",
  "isActive": false
}
```

---

#### Eliminar H√°bito
```http
DELETE /habits/:id
Authorization: Bearer {token}
```

---

#### Registrar Progreso Diario
```http
POST /habits/:id/log
Authorization: Bearer {token}
```

**Body:**
```json
{
  "progress": 1,
  "notes": "Me sent√≠ muy bien hoy"
}
```

**Respuesta (201):**
```json
{
  "id": 1,
  "logDate": "2025-01-15",
  "progress": 1,
  "notes": "Me sent√≠ muy bien hoy",
  "completed": true,
  "createdAt": "2025-01-15T20:30:00Z"
}
```

---

#### Obtener Estad√≠sticas
```http
GET /habits/:id/stats?days=30
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "habitId": 1,
  "habitTitle": "Meditar",
  "totalDays": 30,
  "completedDays": 25,
  "completionRate": 83,
  "currentStreak": 7,
  "logs": [...]
}
```

---

### üß† Inteligencia Artificial (`/ai`)

**‚ö†Ô∏è Requiere autenticaci√≥n JWT en todas las rutas**

#### Analizar Patr√≥n de H√°bito
```http
GET /ai/analyze/:habitId
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "habitId": 1,
  "habitTitle": "Meditar",
  "analysis": {
    "totalDays": 30,
    "completedDays": 25,
    "completionRate": 83,
    "currentStreak": 7,
    "longestStreak": 12,
    "bestDay": "Martes",
    "worstDay": "Domingo",
    "dayPatterns": {
      "Lunes": { "completed": 4, "total": 4, "rate": 100 },
      "Martes": { "completed": 4, "total": 4, "rate": 100 },
      "Mi√©rcoles": { "completed": 3, "total": 4, "rate": 75 },
      "Jueves": { "completed": 4, "total": 4, "rate": 100 },
      "Viernes": { "completed": 3, "total": 4, "rate": 75 },
      "S√°bado": { "completed": 4, "total": 5, "rate": 80 },
      "Domingo": { "completed": 3, "total": 5, "rate": 60 }
    },
    "trend": "improving",
    "suggestions": [
      "¬°Excelente! Mantienes un 83% de cumplimiento.",
      "Los Domingo son tus d√≠as m√°s dif√≠ciles. Intenta prepararte la noche anterior."
    ]
  }
}
```

---

#### Generar Recomendaci√≥n con IA
```http
POST /ai/recommend/:habitId
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "recommendation": "¬°Felicidades! Tu racha de 7 d√≠as demuestra gran consistencia. Observo que los domingos son m√°s desafiantes con solo 60% de cumplimiento. Te sugiero programar tu meditaci√≥n justo despu√©s del desayuno dominical para aprovechar el momento de calma. ¬°Sigue as√≠, est√°s construyendo un h√°bito s√≥lido! üßò‚Äç‚ôÇÔ∏è",
  "analysis": { ... },
  "savedRecommendation": {
    "id": 1,
    "message": "...",
    "category": "pattern_analysis",
    "createdAt": "2025-01-15T21:00:00Z"
  }
}
```

---

#### Obtener Mensaje Motivacional
```http
GET /ai/motivational
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "message": "¬°Incre√≠ble! üí™ Completaste 3 de 4 h√°bitos hoy y llevas una racha promedio de 8 d√≠as. ¬°Sigue adelante, est√°s creando una versi√≥n mejor de ti! ‚ú®",
  "stats": {
    "totalHabits": 4,
    "completedToday": 3,
    "avgStreak": 8
  }
}
```

---

#### Obtener Sugerencias Inteligentes
```http
GET /ai/suggestions
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "suggestions": [
    {
      "habitId": 2,
      "habitTitle": "Hacer ejercicio",
      "type": "low_completion",
      "priority": "high",
      "message": "\"Hacer ejercicio\" tiene solo 35% de cumplimiento. Considera reducir la frecuencia o ajustar el horario.",
      "action": "adjust_frequency"
    },
    {
      "habitId": 1,
      "habitTitle": "Meditar",
      "type": "high_performance",
      "priority": "medium",
      "message": "¬°Excelente trabajo con \"Meditar\"! (90% completado). ¬øListo para un nuevo desaf√≠o?",
      "action": "increase_challenge"
    }
  ],
  "totalSuggestions": 2
}
```

---

#### Obtener Historial de Recomendaciones
```http
GET /ai/recommendations?limit=10
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
[
  {
    "id": 1,
    "message": "Tu an√°lisis personalizado...",
    "category": "pattern_analysis",
    "habit": {
      "id": 1,
      "title": "Meditar"
    },
    "createdAt": "2025-01-15T21:00:00Z"
  }
]
```

---

### üîÑ Sincronizaci√≥n (`/sync`)

**‚ö†Ô∏è Requiere autenticaci√≥n JWT en todas las rutas**

#### Sincronizar Datos
```http
POST /sync
Authorization: Bearer {token}
```

**Body:**
```json
{
  "habits": [
    {
      "localId": "local-1",
      "title": "Nuevo h√°bito offline",
      "frequency": "daily",
      "targetCount": 1,
      "isActive": true,
      "updatedAt": "2025-01-15T10:00:00Z"
    }
  ],
  "logs": [
    {
      "localId": "log-1",
      "habitId": 1,
      "logDate": "2025-01-15",
      "progress": 1,
      "completed": true,
      "updatedAt": "2025-01-15T20:00:00Z"
    }
  ],
  "lastSyncAt": "2025-01-14T10:00:00Z"
}
```

**Respuesta (200):**
```json
{
  "success": true,
  "syncResult": {
    "habits": {
      "created": [
        { "localId": "local-1", "serverId": 5 }
      ],
      "updated": [],
      "conflicts": []
    },
    "logs": {
      "created": [
        { "localId": "log-1", "serverId": 10 }
      ],
      "updated": [],
      "conflicts": []
    },
    "serverChanges": {
      "habits": [],
      "logs": []
    }
  },
  "serverTimestamp": "2025-01-15T22:00:00Z"
}
```

---

#### Obtener Datos del Servidor
```http
GET /sync/server-data?lastSyncAt=2025-01-14T10:00:00Z
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "habits": [...],
  "logs": [...],
  "serverTimestamp": "2025-01-15T22:00:00Z"
}
```

---

### üë§ Usuarios (`/users`)

**‚ö†Ô∏è Requiere autenticaci√≥n JWT en todas las rutas**

#### Obtener Perfil
```http
GET /users/profile
Authorization: Bearer {token}
```

---

#### Actualizar Perfil
```http
PATCH /users/profile
Authorization: Bearer {token}
```

**Body:**
```json
{
  "fullName": "Juan Carlos P√©rez",
  "preferredLanguageId": 1,
  "profilePicture": "https://ejemplo.com/foto.jpg"
}
```

---

#### Obtener Configuraci√≥n
```http
GET /users/settings
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "id": 1,
  "theme": "dark",
  "notificationEnabled": true,
  "reminderTime": "08:00",
  "weeklySummary": true,
  "lastSyncAt": "2025-01-15T22:00:00Z"
}
```

---

#### Actualizar Configuraci√≥n
```http
PATCH /users/settings
Authorization: Bearer {token}
```

**Body:**
```json
{
  "theme": "dark",
  "notificationEnabled": false,
  "reminderTime": "09:00"
}
```

---

#### Eliminar Cuenta
```http
DELETE /users/account
Authorization: Bearer {token}
```

---

### üîî Notificaciones (`/notifications`)

**‚ö†Ô∏è Requiere autenticaci√≥n JWT en todas las rutas**

#### Obtener Notificaciones
```http
GET /notifications?unreadOnly=true
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
[
  {
    "id": 1,
    "title": "¬°Hora de tus h√°bitos!",
    "message": "Tienes 3 h√°bito(s) pendiente(s) hoy. ¬°No olvides completarlos!",
    "scheduledAt": "2025-01-15T08:00:00Z",
    "sentAt": "2025-01-15T08:00:00Z",
    "isRead": false
  },
  {
    "id": 2,
    "title": "Mensaje motivacional del d√≠a",
    "message": "¬°Recuerda que cada peque√±o paso cuenta! Sigue adelante.",
    "scheduledAt": "2025-01-15T09:00:00Z",
    "sentAt": "2025-01-15T09:00:00Z",
    "isRead": false
  },
  {
    "id": 3,
    "title": "¬°Nueva racha!",
    "message": "¬°Felicitaciones! Has completado \"Meditar\" por 3 d√≠as consecutivos.",
    "scheduledAt": "2025-01-15T22:00:00Z",
    "sentAt": "2025-01-15T22:00:00Z",
    "isRead": false
  }
]
```

---

#### Marcar como Le√≠da
```http
PATCH /notifications/:id/read
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "id": 1,
  "title": "¬°Hora de tus h√°bitos!",
  "message": "Tienes 3 h√°bito(s) pendiente(s) hoy. ¬°No olvides completarlos!",
  "isRead": true,
  "readAt": "2025-01-15T10:30:00Z"
}
```

---

#### Marcar Todas como Le√≠das
```http
PATCH /notifications/read-all
Authorization: Bearer {token}
```

**Respuesta (200):**
```json
{
  "message": "Todas las notificaciones marcadas como le√≠das",
  "markedCount": 5
}
```

---

## üîí Autenticaci√≥n y Seguridad

### JWT Token
Todas las rutas protegidas requieren un token JWT en el header:

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```


# üì± Firebase Cloud Messaging (FCM) - Secci√≥n para README


## üîî Firebase Cloud Messaging (FCM)

### Caracter√≠sticas Implementadas

- ‚úÖ Registro autom√°tico de tokens de dispositivos
- ‚úÖ Env√≠o autom√°tico de push notifications con cada notificaci√≥n
- ‚úÖ Soporte para m√∫ltiples dispositivos por usuario
- ‚úÖ Detecci√≥n y limpieza de tokens inv√°lidos
- ‚úÖ Reintentos autom√°ticos de notificaciones fallidas
- ‚úÖ Soporte para iOS, Android y Web
- ‚úÖ Tracking de estado de env√≠o (exitoso/fallido)

### Configuraci√≥n

#### 1. Obtener Credenciales de Firebase

1. Ve a [Firebase Console](https://console.firebase.google.com/)
2. Crea o selecciona tu proyecto
3. Ve a **Project Settings** > **Service Accounts**
4. Haz clic en **Generate new private key**
5. Guarda el archivo JSON

#### 2. Configurar Variables de Entorno

Agrega al archivo `.env`:

```env
# Opci√≥n 1: Usar archivo JSON (recomendado)
FIREBASE_CREDENTIALS_PATH=./config/firebase-admin-sdk.json

# Opci√≥n 2: Variables individuales
FIREBASE_PROJECT_ID=tu-proyecto-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk@tu-proyecto.iam.gserviceaccount.com
```

#### 3. Ejecutar Migraci√≥n de Base de Datos

```bash
psql -U postgres -d habit_manager -f migrations/device_tokens.sql
```

### Endpoints FCM

#### Registrar Token de Dispositivo

```http
POST /api/v1/fcm/register
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "token": "fcm_token_del_dispositivo",
  "deviceType": "android",
  "deviceName": "Samsung Galaxy S21"
}
```

#### Desregistrar Token (Logout)

```http
DELETE /api/v1/fcm/unregister
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "token": "fcm_token_del_dispositivo"
}
```

### Funcionamiento Autom√°tico

#### Notificaciones que Env√≠an Push Autom√°ticamente:

1. **Recordatorios Diarios** (8:00 AM)
   - Se env√≠a a todos los usuarios con notificaciones habilitadas
   - Informa sobre h√°bitos pendientes del d√≠a

2. **Mensajes Motivacionales** (9:00 AM)
   - Mensaje inspirador diario
   - Aleatorio de una lista predefinida

3. **Notificaciones de Rachas** (10:00 PM)
   - Al completar 3, 7 o 30 d√≠as consecutivos
   - Celebraci√≥n de logros

4. **Res√∫menes Semanales** (Cada lunes)
   - Estad√≠sticas de la semana anterior
   - Tasa de cumplimiento

5. **Alertas de Seguridad**
   - Login desde nueva ubicaci√≥n
   - Intentos fallidos de login

### Estructura de la Notificaci√≥n Push

```json
{
  "notification": {
    "title": "¬°Hora de tus h√°bitos! üéØ",
    "body": "Tienes 3 h√°bito(s) pendiente(s) hoy."
  },
  "data": {
    "notificationId": "123",
    "type": "habit_reminder"
  }
}
```

### Tablas de Base de Datos

#### `device_tokens`
- Almacena tokens FCM de dispositivos
- Relacionada con usuarios (ON DELETE CASCADE)
- Campos: token, deviceType, deviceName, isActive

#### `notifications` (actualizada)
- Nuevos campos: `push_sent`, `push_sent_at`, `push_error`
- Tracking de estado de env√≠o push

### Cron Jobs FCM

| Cron Job | Frecuencia | Descripci√≥n |
|----------|-----------|-------------|
| `sendDailyReminders` | Diario 8:00 AM | Recordatorios de h√°bitos |
| `sendMotivationalMessages` | Diario 9:00 AM | Mensajes motivacionales |
| `checkStreaksAndAchievements` | Diario 10:00 PM | Notificaciones de logros |
| `sendWeeklySummaries` | Semanal (Lunes) | Res√∫menes semanales |
| `retryFailedPushNotifications` | Cada hora | Reintentar env√≠os fallidos |


### Troubleshooting

#### ‚ùå Error: "Firebase not initialized"
```bash
# Verificar que existan las credenciales
ls config/firebase-admin-sdk.json

# O verificar variables de entorno
echo $FIREBASE_PROJECT_ID
```

#### ‚ùå Error: "messaging/invalid-registration-token"
- El token FCM es inv√°lido o expir√≥
- Se marca autom√°ticamente como inactivo
- El cliente debe registrar un nuevo token

#### ‚ùå No se reciben notificaciones push
1. Verificar que Firebase est√© inicializado correctamente
2. Verificar que el usuario tenga `notificationEnabled: true`
3. Verificar que existan tokens activos en la BD
4. Revisar logs de la columna `push_error` en la tabla `notifications`

### Testing con curl

```bash
# Registrar token de prueba
curl -X POST https://tu-api.com/api/v1/fcm/register \
  -H "Authorization: Bearer {jwt_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "token": "test_token_123",
    "deviceType": "android",
    "deviceName": "Test Device"
  }'

# Crear notificaci√≥n (se enviar√° push autom√°ticamente)
curl -X POST https://tu-api.com/api/v1/notifications \
  -H "Authorization: Bearer {jwt_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Test Push",
    "message": "Probando notificaci√≥n push",
    "sendPush": true
  }'
```

### Seguridad

- ‚úÖ Las credenciales de Firebase no se exponen al cliente
- ‚úÖ Tokens FCM vinculados a usuarios autenticados (JWT)
- ‚úÖ Validaci√≥n de pertenencia antes de enviar push
- ‚úÖ Limpieza autom√°tica de tokens inv√°lidos
- ‚úÖ Tokens se desactivan en logout

### Performance

- Env√≠o en lote usando `sendEachForMulticast`
- M√°ximo 500 tokens por lote (l√≠mite de Firebase)
- Reintentos autom√°ticos cada hora
- Limpieza semanal de tokens antiguos

### Integraci√≥n con Cliente M√≥vil

Ver documentaci√≥n completa en: [FCM_CLIENT_INTEGRATION.md](./docs/FCM_CLIENT_INTEGRATION.md)

#### Flujo b√°sico:

```
1. Usuario hace login ‚Üí Obtiene JWT
2. App obtiene FCM token ‚Üí POST /fcm/register
3. Servidor crea notificaci√≥n ‚Üí Env√≠a push autom√°ticamente
4. Usuario recibe notificaci√≥n en tiempo real
5. Al hacer logout ‚Üí DELETE /fcm/unregister
```

---

## üìä Estad√≠sticas de Notificaciones

### Consultas SQL √ötiles

```sql
-- Ver tokens activos por usuario
SELECT u.email, COUNT(dt.id) as devices_count
FROM users u
LEFT JOIN device_tokens dt ON dt.user_id = u.id AND dt.is_active = true
GROUP BY u.email;

-- Ver notificaciones enviadas hoy
SELECT 
  COUNT(*) as total_sent,
  SUM(CASE WHEN push_sent = true THEN 1 ELSE 0 END) as push_sent,
  SUM(CASE WHEN push_error IS NOT NULL THEN 1 ELSE 0 END) as push_failed
FROM notifications
WHERE sent_at::date = CURRENT_DATE;

-- Ver tokens por tipo de dispositivo
SELECT device_type, COUNT(*) as count
FROM device_tokens
WHERE is_active = true
GROUP BY device_type;

-- Ver usuarios sin tokens registrados
SELECT u.email, u.full_name
FROM users u
LEFT JOIN device_tokens dt ON dt.user_id = u.id AND dt.is_active = true
WHERE u.is_active = true AND dt.id IS NULL;
```

## üìñ Referencias

- [Firebase Cloud Messaging Docs](https://firebase.google.com/docs/cloud-messaging)
- [Firebase Admin SDK](https://firebase.google.com/docs/admin/setup)
- [Best Practices for FCM](https://firebase.google.com/docs/cloud-messaging/best-practices)



### Flujo de Autenticaci√≥n

1. **Registro** ‚Üí Usuario recibe c√≥digo de verificaci√≥n por email
2. **Verificar Email** ‚Üí Usuario confirma c√≥digo de 6 d√≠gitos
3. **Login** ‚Üí Sistema env√≠a c√≥digo 2FA
4. **Verificar 2FA** ‚Üí Usuario recibe token JWT
5. **Acceso a rutas protegidas** ‚Üí Incluir token en header

### Seguridad Implementada
- ‚úÖ Hash de contrase√±as con bcrypt (salt rounds: 10)
- ‚úÖ Tokens JWT con expiraci√≥n configurable
- ‚úÖ Verificaci√≥n de email obligatoria
- ‚úÖ 2FA obligatorio en login
- ‚úÖ Rate limiting de intentos de verificaci√≥n (m√°x. 3)
- ‚úÖ C√≥digos de verificaci√≥n con expiraci√≥n (10 minutos)
- ‚úÖ Registro de intentos de login (auditor√≠a)
- ‚úÖ CORS configurado
- ‚úÖ Helmet para headers de seguridad
- ‚úÖ Validaci√≥n de DTOs con class-validator

---

## ‚è≥ Funcionalidades Pendientes

### Alta Prioridad
- ‚ö†Ô∏è **Firebase Cloud Messaging (FCM)** - Notificaciones push reales para app m√≥vil
- ‚úÖ **Cron Jobs** - Sistema completo de tareas programadas para notificaciones autom√°ticas
- ‚ö†Ô∏è **Rate Limiting** - Limitar peticiones por IP/usuario
- ‚ö†Ô∏è **Paginaci√≥n** - Implementar en listados grandes

### Media Prioridad
- üîú **OAuth2 Google** - Login con Google
- üîú **Exportar datos** - CSV/PDF de estad√≠sticas
- üîú **WebSockets** - Sincronizaci√≥n en tiempo real
- üîú **Cach√©** - Redis para mejorar rendimiento
- üîú **Tests unitarios y e2e** - Cobertura completa

### Baja Prioridad
- üîú **Gamificaci√≥n** - Sistema de logros y puntos
- üîú **Comunidad** - Rankings sociales
- üîú **M√°s idiomas** - Expansi√≥n multilenguaje
- üîú **Subida de archivos** - AWS S3 para fotos de perfil

---

## üìÅ Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ ai/                    # M√≥dulo de IA
‚îÇ   ‚îú‚îÄ‚îÄ ai.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ ai.service.ts      # An√°lisis y recomendaciones con OpenAI
‚îÇ   ‚îî‚îÄ‚îÄ ai.module.ts
‚îú‚îÄ‚îÄ auth/                  # Autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts    # Login, registro, 2FA
‚îÇ   ‚îú‚îÄ‚îÄ dto/               # DTOs de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ guards/            # JWT Auth Guard
‚îÇ   ‚îú‚îÄ‚îÄ service/           # Servicios auxiliares (token cleanup)
‚îÇ   ‚îî‚îÄ‚îÄ strategies/        # JWT Strategy
‚îú‚îÄ‚îÄ email/                 # Servicio de emails
‚îÇ   ‚îú‚îÄ‚îÄ email.service.ts   # Nodemailer + templates HTML
‚îÇ   ‚îî‚îÄ‚îÄ email.module.ts
‚îú‚îÄ‚îÄ entities/              # Entidades TypeORM
‚îÇ   ‚îú‚îÄ‚îÄ user.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ habit.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ habit-log.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ ai-recommendation.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ verification-code.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ login-attempt.entity.ts
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ habits/                # Gesti√≥n de h√°bitos
‚îÇ   ‚îú‚îÄ‚îÄ habits.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ habits.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ dto/               # DTOs para h√°bitos
‚îÇ   ‚îî‚îÄ‚îÄ habits.module.ts
‚îú‚îÄ‚îÄ notifications/         # Notificaciones
‚îÇ   ‚îú‚îÄ‚îÄ notifications.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ notifications.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ notifications.module.ts
‚îú‚îÄ‚îÄ sync/                  # Sincronizaci√≥n offline
‚îÇ   ‚îú‚îÄ‚îÄ sync.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ sync.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ dto/               # DTOs de sincronizaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ sync.module.ts
‚îú‚îÄ‚îÄ users/                 # Gesti√≥n de usuarios
‚îÇ   ‚îú‚îÄ‚îÄ users.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ users.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ dto/               # DTOs de usuarios
‚îÇ   ‚îî‚îÄ‚îÄ users.module.ts
‚îú‚îÄ‚îÄ verification/          # Verificaci√≥n de c√≥digos
‚îÇ   ‚îú‚îÄ‚îÄ verification.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ verification.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ dto/               # DTOs de verificaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ verification.module.ts
‚îú‚îÄ‚îÄ app.module.ts          # M√≥dulo ra√≠z
‚îî‚îÄ‚îÄ main.ts                # Punto de entrada
```

---

## üß™ Testing

```bash
# Tests unitarios
npm run test

# Tests e2e
npm run test:e2e

# Cobertura
npm run test:cov
```

**‚ö†Ô∏è Nota:** Los tests est√°n pendientes de implementaci√≥n.

---

## üêõ Logging y Debugging

```bash
# Modo desarrollo con logs detallados
npm run start:dev

# Modo debug
npm run start:debug
```

La aplicaci√≥n usa **morgan** para logging HTTP en desarrollo y TypeORM logging para queries SQL.

### Logs de Verificaci√≥n 2FA
Los procesos de verificaci√≥n 2FA incluyen logs detallados para debugging:
- ‚úÖ C√≥digo recibido vs almacenado
- ‚úÖ Fecha de expiraci√≥n
- ‚úÖ N√∫mero de intentos actuales
- ‚úÖ Estado de verificaci√≥n exitosa/fallida
- ‚úÖ Env√≠o de emails de 2FA

---

## üìä Base de Datos

### Tablas Principales
- `users` - Usuarios del sistema
- `user_settings` - Configuraci√≥n de usuario
- `habits` - H√°bitos creados
- `habit_logs` - Registro diario de progreso
- `ai_recommendations` - Recomendaciones generadas
- `verification_codes` - C√≥digos de verificaci√≥n (email, 2FA, reset)
- `login_attempts` - Auditor√≠a de logins
- `notifications` - Notificaciones inteligentes autom√°ticas
- `languages` - Idiomas disponibles
- `refresh_tokens` - Tokens de refresco JWT

### Migraciones
Actualmente se usa el archivo SQL `habit_ai_v2.sql` para crear el esquema.

**‚ö†Ô∏è Recomendaci√≥n:** Implementar migraciones con TypeORM para control de versiones.

---

## üöÄ Despliegue

### Opciones Recomendadas
1. **Render** - Deploy autom√°tico con PostgreSQL incluido
2. **Railway** - F√°cil configuraci√≥n con variables de entorno
3. **AWS EC2 + RDS** - Mayor control y escalabilidad
4. **Heroku** - Deploy simple (con PostgreSQL addon)

### Checklist de Producci√≥n
- [ ] Configurar variables de entorno
- [ ] Usar `synchronize: false` en TypeORM
- [ ] Implementar rate limiting
- [ ] Configurar CORS correctamente
- [ ] Habilitar HTTPS
- [ ] Configurar logs con Winston
- [ ] Implementar health check endpoint
- [ ] Configurar backup de BD

---

## üìù Notas Importantes

1. **OpenAI API Key**: Si no se configura, el sistema usa mensajes motivacionales predeterminados en lugar de generar recomendaciones con IA.

2. **C√≥digos de Verificaci√≥n**: Expiran en 10 minutos y tienen m√°ximo 3 intentos.

3. **2FA Obligatorio**: Todos los logins requieren verificaci√≥n 2FA por seguridad.

4. **Sincronizaci√≥n**: El sistema detecta conflictos cuando el servidor tiene datos m√°s recientes que el cliente.

5. **An√°lisis IA**: Requiere al menos 7 d√≠as de logs para generar an√°lisis significativo.

6. **Notificaciones Autom√°ticas**: Se ejecutan seg√∫n horarios programados y respetan la configuraci√≥n `notificationEnabled` del usuario.

7. **Recordatorios Personalizados**: Los recordatorios diarios se env√≠an a la hora configurada en `reminderTime` (por defecto 08:00).

8. **Notificaciones de Seguridad**: Se activan autom√°ticamente ante intentos fallidos de login o accesos desde nuevas ubicaciones.

9. **Restricci√≥n unique_active_code**: Solucionada eliminando c√≥digos usados antiguos antes de marcar nuevos como usados, evitando conflictos de unicidad en la base de datos.

---

## üë®‚Äçüíª Autor

**Julio Otero**  
Desarrollador Backend - Habit Manager API

---

## ü§ù Contribuci√≥n
Abiertas
---

**Estado del Proyecto:** üü¢ En desarrollo activo
